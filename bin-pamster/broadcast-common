# -*- mode: sh; sh-shell: bash -*-

## This exists to be sourced by other scripts to factor out common code.

function error {
    echo "$@" 1>&2
    exit 1
}

function main {
    if [[ "$(hostname)" != pamster ]]; then
        error "must run this from pamster"
    fi

    MESSAGE="$1"
    shift

    echo "$MESSAGE on dmi-skinny..."
    ssh dmi-skinny -- "$@"
    echo

    echo "Assuming that VPN is DOWN on dmi-skinny..."
    echo "$MESSAGE on nils..."
    ## As of 2025-08-10, from the VPN I cannot get to nils, hence the
    ## extra hop via dmi-skinny.
    ssh dmi-skinny ssh nils "$@"
    echo

    echo "Assuming that kruemel is powered on..."
    echo "$MESSAGE on kruemel..."
    ssh kruemel "$@"
    echo

    echo "Assuming that VPN is up..."
    echo "$MESSAGE on dmi-kibo..."
    ssh kibo "$@"
    echo

    echo "Assuming that VPN is up..."
    echo "$MESSAGE on grid..."
    ssh grid "$@"
    echo

    echo "Done."
}
