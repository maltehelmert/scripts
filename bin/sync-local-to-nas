#! /bin/bash

## This script is meant to back up the backup files and other data on
## pamster:/local to the NAS.
## It should be run after the various "sync-..." scripts on pamster
## so that the data on pamster:/local is up to date.

HOST="$(hostname -s)"
CORRECT_HOST=pamster

## Set destination directory and excludes.
if [[ "$HOST" == "$CORRECT_HOST" ]]; then
    SRC_DIR=/local/
    ## NOTE: I used DEST_DIR=/nas/ in the past, but the combination of
    ## large files (tens of GB) and going via NFS led to serious
    ## issues, frequently invoking the kernel's oom killer taking down
    ## entire terminal sessions. Going to the NAS via ssh seems a
    ## better way to do this.
    ##
    ## The main drawback is that the path on the other side only
    ## appear to be semi-documented and might eventually change. But
    ## from a web search it seems clear that many people are using the
    ## same approach, so perhaps it counts as supported.
    DEST_DIR=hamsterhausen:/share/data/helmert/
    OPTIONS="--info=progress2 --exclude=/lost+found --exclude=/android-photos"
    ## Regarding --exclude=/android-photos:
    ## - Makes sure we don't delete /nas/android-photos, which is synced from
    ##   the Android phone and doesn't exist on pamster.
    ## - Perhaps this should not live in the same directory as the directories
    ##   we sync from /local because this exclude is fragile.
    ## - Perhaps we should sync this from the NAS to other machines, too,
    ##   for backup purposes. But at least we have one copy on the phone and
    ##   one on the NAS, and the NAS also has RAID.
else
    echo "This script is only meant to be run from $CORRECT_HOST -- exiting."
    exit 1
fi

## Unlike sync-jukebox, this sync script deletes by default.
##
## For this script, deletions are common, and because we only ever
## sync in one direction, this should be safe to use.

rsync -avz --partial --progress --delete $SRC_DIR $OPTIONS $DEST_DIR
